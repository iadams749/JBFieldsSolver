<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jumbleberry Fields Solver</title>
<style>
  :root {
    --bg: #1a1a2e;
    --surface: #16213e;
    --card: #0f3460;
    --accent: #e94560;
    --accent-hover: #ff6b81;
    --text: #eee;
    --text-muted: #a0a0b8;
    --success: #4ecdc4;
    --warning: #ffe66d;
    --berry-j: #e94560;
    --berry-s: #f8a5c2;
    --berry-p: #78e08f;
    --berry-m: #a29bfe;
    --berry-x: #636e72;
    --radius: 8px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  header {
    text-align: center;
    padding: 2rem 1rem 1rem;
  }

  header h1 {
    font-size: 2rem;
    display: inline;
    background: linear-gradient(135deg, var(--accent), var(--berry-m));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .title-row {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }

  header p {
    color: var(--text-muted);
    margin-top: 0.4rem;
    font-size: 0.95rem;
  }

  main {
    width: 100%;
    max-width: 720px;
    padding: 0 1rem 2rem;
  }

  .card {
    background: var(--surface);
    border: 1px solid rgba(255,255,255,0.06);
    border-radius: var(--radius);
    padding: 1.25rem;
    margin-bottom: 1rem;
  }

  .card h2 {
    font-size: 1rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-muted);
    margin-bottom: 0.75rem;
  }

  /* Dice Input */
  .dice-input-row {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    flex-wrap: wrap;
  }

  .dice-slot {
    width: 56px;
    height: 56px;
    border-radius: var(--radius);
    border: 2px solid rgba(255,255,255,0.15);
    background: var(--card);
    color: var(--text);
    font-size: 1.4rem;
    font-weight: 700;
    text-align: center;
    cursor: pointer;
    transition: border-color 0.15s, background 0.15s;
    -webkit-appearance: none;
    appearance: none;
    padding: 0;
  }

  .dice-slot:focus {
    outline: none;
    border-color: var(--accent);
  }

  .dice-slot option { font-size: 1.1rem; }

  .dice-slot.berry-J { border-color: var(--berry-j); background: rgba(233,69,96,0.15); }
  .dice-slot.berry-S { border-color: var(--berry-s); background: rgba(248,165,194,0.15); }
  .dice-slot.berry-P { border-color: var(--berry-p); background: rgba(120,224,143,0.15); }
  .dice-slot.berry-M { border-color: var(--berry-m); background: rgba(162,155,254,0.15); }
  .dice-slot.berry-X { border-color: var(--berry-x); background: rgba(99,110,114,0.15); }

  .dice-labels {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.25rem;
  }

  .dice-labels span {
    width: 56px;
    text-align: center;
    font-size: 0.7rem;
    color: var(--text-muted);
  }

  /* Rolls Left */
  .rolls-row {
    display: flex;
    gap: 0.5rem;
    align-items: center;
  }

  .roll-btn {
    width: 48px;
    height: 40px;
    border-radius: var(--radius);
    border: 2px solid rgba(255,255,255,0.15);
    background: var(--card);
    color: var(--text);
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
  }

  .roll-btn:hover { border-color: var(--accent); }
  .roll-btn.active {
    border-color: var(--accent);
    background: var(--accent);
    color: #fff;
  }

  /* Categories */
  .cat-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
    gap: 0.4rem;
  }

  .cat-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.45rem 0.6rem;
    border-radius: var(--radius);
    cursor: pointer;
    transition: background 0.12s;
    user-select: none;
  }

  .cat-item:hover { background: rgba(255,255,255,0.04); }

  .cat-item input[type="checkbox"] {
    accent-color: var(--accent);
    width: 18px;
    height: 18px;
    cursor: pointer;
  }

  .cat-item label {
    cursor: pointer;
    font-size: 0.9rem;
  }

  .cat-shortcuts {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.5rem;
    flex-wrap: wrap;
  }

  .cat-shortcut-btn {
    padding: 0.3rem 0.7rem;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,0.12);
    background: transparent;
    color: var(--text-muted);
    font-size: 0.78rem;
    cursor: pointer;
    transition: all 0.15s;
  }

  .cat-shortcut-btn:hover {
    border-color: var(--accent);
    color: var(--text);
  }

  /* Score Input */
  .score-input-row {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .score-input-row input {
    width: 100px;
    padding: 0.5rem 0.6rem;
    border-radius: var(--radius);
    border: 2px solid rgba(255,255,255,0.15);
    background: var(--card);
    color: var(--text);
    font-size: 1rem;
    font-weight: 600;
    text-align: center;
    -moz-appearance: textfield;
  }

  .score-input-row input::-webkit-outer-spin-button,
  .score-input-row input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }

  .score-input-row input:focus {
    outline: none;
    border-color: var(--accent);
  }

  /* Solve Button */
  .solve-row {
    display: flex;
    justify-content: center;
    margin: 0.5rem 0;
  }

  #solveBtn {
    padding: 0.7rem 2.5rem;
    border: none;
    border-radius: var(--radius);
    background: var(--accent);
    color: #fff;
    font-size: 1.05rem;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.15s, transform 0.1s;
  }

  #solveBtn:hover { background: var(--accent-hover); }
  #solveBtn:active { transform: scale(0.97); }
  #solveBtn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* Results */
  #results { display: none; }

  .best-action-banner {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    border-radius: var(--radius);
    margin-bottom: 0.5rem;
  }

  .best-action-banner.score {
    background: linear-gradient(135deg, rgba(78,205,196,0.2), rgba(78,205,196,0.05));
    border-left: 4px solid var(--success);
  }

  .best-action-banner.reroll {
    background: linear-gradient(135deg, rgba(255,230,109,0.2), rgba(255,230,109,0.05));
    border-left: 4px solid var(--warning);
  }

  .best-action-banner .action-type {
    font-size: 0.8rem;
    text-transform: uppercase;
    font-weight: 700;
    letter-spacing: 0.05em;
  }

  .best-action-banner.score .action-type { color: var(--success); }
  .best-action-banner.reroll .action-type { color: var(--warning); }

  .best-action-banner .action-detail {
    font-size: 1.15rem;
    font-weight: 600;
  }

  .best-action-banner .action-ev {
    margin-left: auto;
    font-size: 1.4rem;
    font-weight: 700;
  }

  .meta-row {
    display: flex;
    justify-content: space-between;
    color: var(--text-muted);
    font-size: 0.85rem;
    margin-bottom: 0.75rem;
    padding: 0 0.25rem;
  }

  /* Tables */
  .result-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.88rem;
  }

  .result-table th {
    text-align: left;
    padding: 0.5rem 0.6rem;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    color: var(--text-muted);
    font-weight: 600;
    font-size: 0.78rem;
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }

  .result-table th.num { text-align: right; }

  .result-table td {
    padding: 0.45rem 0.6rem;
    border-bottom: 1px solid rgba(255,255,255,0.04);
  }

  .result-table td.num { text-align: right; font-variant-numeric: tabular-nums; }

  .result-table tr:first-child td {
    background: rgba(255,255,255,0.03);
    font-weight: 600;
  }

  .result-table tr:hover td {
    background: rgba(255,255,255,0.04);
  }

  .error-msg {
    color: var(--accent);
    text-align: center;
    padding: 1rem;
  }

  /* Loading overlay */
  #loadingOverlay {
    position: fixed;
    inset: 0;
    background: rgba(26,26,46,0.95);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 100;
  }

  .spinner {
    width: 40px;
    height: 40px;
    border: 3px solid rgba(255,255,255,0.1);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  #loadingOverlay p {
    margin-top: 1rem;
    color: var(--text-muted);
  }

  /* Responsive */
  /* Info icon & tooltip */
  .info-wrapper {
    position: relative;
    display: inline-block;
    margin-left: 0.5rem;
    vertical-align: middle;
  }

  .info-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    border: 1.5px solid var(--text-muted);
    color: var(--text-muted);
    font-size: 0.85rem;
    font-weight: 700;
    font-style: italic;
    font-family: Georgia, 'Times New Roman', serif;
    cursor: help;
    transition: border-color 0.15s, color 0.15s;
  }

  .info-icon:hover {
    border-color: var(--accent);
    color: var(--accent);
  }

  .info-tooltip {
    display: none;
    position: absolute;
    top: calc(100% + 10px);
    left: 50%;
    transform: translateX(-50%);
    width: 340px;
    background: var(--card);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: var(--radius);
    padding: 1rem 1.1rem;
    z-index: 200;
    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    font-size: 0.82rem;
    line-height: 1.55;
    color: var(--text);
    text-align: left;
  }

  .info-tooltip::before {
    content: '';
    position: absolute;
    top: -6px;
    left: 50%;
    transform: translateX(-50%);
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-bottom: 6px solid rgba(255,255,255,0.12);
  }

  .info-wrapper:hover .info-tooltip {
    display: block;
  }

  .info-tooltip h3 {
    font-size: 0.88rem;
    margin-bottom: 0.4rem;
    color: var(--accent);
  }

  .info-tooltip p {
    margin-bottom: 0.55rem;
    color: var(--text);
  }

  .info-tooltip .key-grid {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 0.15rem 0.6rem;
    margin-bottom: 0.55rem;
  }

  .info-tooltip .key-letter {
    font-weight: 700;
    font-size: 0.9rem;
  }

  .info-tooltip .key-letter.kj { color: var(--berry-j); }
  .info-tooltip .key-letter.ks { color: var(--berry-s); }
  .info-tooltip .key-letter.kp { color: var(--berry-p); }
  .info-tooltip .key-letter.km { color: var(--berry-m); }
  .info-tooltip .key-letter.kx { color: var(--berry-x); }

  .info-tooltip .key-desc {
    color: var(--text-muted);
  }

  @media (max-width: 500px) {
    .dice-slot { width: 48px; height: 48px; font-size: 1.2rem; }
    .dice-labels span { width: 48px; }
    .cat-grid { grid-template-columns: 1fr 1fr; }
    .info-tooltip { width: 280px; }
  }
</style>
</head>
<body>

<div id="loadingOverlay">
  <div class="spinner"></div>
  <p id="loadingText">Loading solver engine…</p>
</div>

<header>
  <div class="title-row">
    <h1>Jumbleberry Fields Solver</h1>
    <span class="info-wrapper">
      <span class="info-icon">i</span>
      <div class="info-tooltip">
        <h3>How to Use</h3>
        <p>Set each die to match your current roll, choose how many rerolls you have left, and check the categories you haven&rsquo;t scored yet. Then hit <strong>Solve</strong>.</p>
        <h3>Die Key</h3>
        <div class="key-grid">
          <span class="key-letter kj">J</span><span class="key-desc">Jumbleberry &mdash; 2 pts (30%)</span>
          <span class="key-letter ks">S</span><span class="key-desc">Sugarberry &mdash; 2 pts (30%)</span>
          <span class="key-letter kp">P</span><span class="key-desc">Pickleberry &mdash; 4 pts (20%)</span>
          <span class="key-letter km">M</span><span class="key-desc">Moonberry &mdash; 7 pts (10%)</span>
          <span class="key-letter kx">X</span><span class="key-desc">Pest &mdash; 0 pts (10%)</span>
        </div>
        <h3>Results</h3>
        <p>The solver returns the <strong>optimal action</strong> (score or reroll), the <strong>expected value</strong> of that action, and a ranked list of alternatives.</p>
      </div>
    </span>
  </div>
  <p>Optimal strategy calculator</p>
</header>

<main>
  <!-- Dice Input -->
  <div class="card">
    <h2>Dice</h2>
    <div class="dice-input-row">
      <select class="dice-slot" data-die="0"><option value="J">J</option><option value="S">S</option><option value="P">P</option><option value="M">M</option><option value="X">X</option></select>
      <select class="dice-slot" data-die="1"><option value="J">J</option><option value="S">S</option><option value="P">P</option><option value="M">M</option><option value="X">X</option></select>
      <select class="dice-slot" data-die="2"><option value="J">J</option><option value="S">S</option><option value="P">P</option><option value="M">M</option><option value="X">X</option></select>
      <select class="dice-slot" data-die="3"><option value="J">J</option><option value="S">S</option><option value="P">P</option><option value="M">M</option><option value="X">X</option></select>
      <select class="dice-slot" data-die="4"><option value="J">J</option><option value="S">S</option><option value="P">P</option><option value="M">M</option><option value="X">X</option></select>
    </div>
    <div class="dice-labels">
      <span>Die 1</span><span>Die 2</span><span>Die 3</span><span>Die 4</span><span>Die 5</span>
    </div>
  </div>

  <!-- Rolls Left -->
  <div class="card">
    <h2>Rolls Left</h2>
    <div class="rolls-row">
      <button class="roll-btn" data-rolls="0">0</button>
      <button class="roll-btn" data-rolls="1">1</button>
      <button class="roll-btn active" data-rolls="2">2</button>
    </div>
  </div>

  <!-- Categories -->
  <div class="card">
    <h2>Categories Remaining</h2>
    <div class="cat-grid">
      <div class="cat-item"><input type="checkbox" id="cat-j" value="j" checked><label for="cat-j">Jumbleberry</label></div>
      <div class="cat-item"><input type="checkbox" id="cat-s" value="s" checked><label for="cat-s">Sugarberry</label></div>
      <div class="cat-item"><input type="checkbox" id="cat-p" value="p" checked><label for="cat-p">Pickleberry</label></div>
      <div class="cat-item"><input type="checkbox" id="cat-m" value="m" checked><label for="cat-m">Moonberry</label></div>
      <div class="cat-item"><input type="checkbox" id="cat-3k" value="3k" checked><label for="cat-3k">Basket of Three</label></div>
      <div class="cat-item"><input type="checkbox" id="cat-4k" value="4k" checked><label for="cat-4k">Basket of Four</label></div>
      <div class="cat-item"><input type="checkbox" id="cat-5k" value="5k" checked><label for="cat-5k">Basket of Five</label></div>
      <div class="cat-item"><input type="checkbox" id="cat-mix" value="mix" checked><label for="cat-mix">Mixed Basket</label></div>
      <div class="cat-item"><input type="checkbox" id="cat-fr" value="fr" checked><label for="cat-fr">Free Roll</label></div>
    </div>
    <div class="cat-shortcuts">
      <button class="cat-shortcut-btn" onclick="setCats('all')">All</button>
      <button class="cat-shortcut-btn" onclick="setCats('none')">None</button>
    </div>
  </div>

  <!-- Current Score -->
  <div class="card">
    <h2>Current Score</h2>
    <div class="score-input-row">
      <input type="number" id="currentScore" min="0" max="999" value="0" placeholder="0">
      <span style="color: var(--text-muted); font-size: 0.85rem;">Points scored so far this game</span>
    </div>
  </div>

  <!-- Solve -->
  <div class="solve-row">
    <button id="solveBtn" disabled>Solve</button>
  </div>

  <!-- Results -->
  <div id="results" class="card">
    <div id="bestActionBanner" class="best-action-banner"></div>
    <div id="metaRow" class="meta-row"></div>
    <div id="resultBody"></div>
  </div>
</main>

<!-- Go WASM support -->
<script src="wasm_exec.js"></script>
<script>
// ── State ──
let wasmReady = false;
let rollsLeft = 2;

// ── Dice selects ──
const diceSlots = document.querySelectorAll('.dice-slot');
diceSlots.forEach(sel => {
  sel.addEventListener('change', () => {
    sel.className = 'dice-slot berry-' + sel.value;
  });
  sel.className = 'dice-slot berry-' + sel.value;
});

// ── Rolls Left ──
const rollBtns = document.querySelectorAll('.roll-btn');
rollBtns.forEach(btn => {
  btn.addEventListener('click', () => {
    rollBtns.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    rollsLeft = parseInt(btn.dataset.rolls);
  });
});

// ── Category shortcuts ──
function setCats(preset) {
  const boxes = document.querySelectorAll('.cat-grid input[type="checkbox"]');
  if (preset === 'all') boxes.forEach(b => b.checked = true);
  else if (preset === 'none') boxes.forEach(b => b.checked = false);
}

// ── Build inputs ──
function getDiceString() {
  return Array.from(diceSlots).map(s => s.value).join('');
}

function getCategoriesString() {
  const checked = Array.from(document.querySelectorAll('.cat-grid input:checked'));
  if (checked.length === 0) return '';
  if (checked.length === 9) return 'all';
  return checked.map(c => c.value).join(',');
}

// ── Solve ──
document.getElementById('solveBtn').addEventListener('click', () => {
  const cats = getCategoriesString();
  if (!cats) {
    showError('Select at least one category');
    return;
  }

  const req = JSON.stringify({
    dice: getDiceString(),
    rolls_left: rollsLeft,
    categories: cats
  });

  const raw = jbfSolve(req);
  let resp;
  try {
    resp = JSON.parse(raw);
  } catch (e) {
    showError('Failed to parse solver response');
    return;
  }

  if (resp.error) {
    showError(resp.error);
    return;
  }

  renderResults(resp);
});

// ── Render ──
function showError(msg) {
  const results = document.getElementById('results');
  results.style.display = 'block';
  document.getElementById('bestActionBanner').innerHTML = '';
  document.getElementById('metaRow').innerHTML = '';
  document.getElementById('resultBody').innerHTML = `<div class="error-msg">${escHtml(msg)}</div>`;
}

function renderResults(r) {
  const results = document.getElementById('results');
  results.style.display = 'block';

  const ba = r.best_action;
  const isScore = ba.type === 'score';
  const banner = document.getElementById('bestActionBanner');
  banner.className = 'best-action-banner ' + ba.type;

  let detail = '';
  if (isScore) {
    detail = `Score in <strong>${escHtml(ba.category)}</strong>`;
  } else {
    const keepText = ba.keep || 'nothing';
    detail = `Reroll &mdash; keep <strong>${escHtml(keepText)}</strong>`;
  }

  const currentScore = parseInt(document.getElementById('currentScore').value) || 0;
  const gameEV = currentScore + ba.ev;
  const gameMax = currentScore + r.theoretical_max;

  banner.innerHTML = `
    <div>
      <div class="action-type">${isScore ? 'Score' : 'Reroll'}</div>
      <div class="action-detail">${detail}</div>
    </div>
    <div class="action-ev"><div style="font-size:0.6rem;font-weight:400;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.04em;">Expected Game Score</div>${gameEV.toFixed(2)}</div>
  `;

  document.getElementById('metaRow').innerHTML = `
    <span>Breakdown: ${currentScore} current + ${ba.ev.toFixed(2)} future = ${gameEV.toFixed(2)}</span>
    <span>Theoretical max: ${gameMax.toFixed(0)}</span>
  `;

  let body = '';

  if (r.category_options && r.category_options.length > 0) {
    body += `<table class="result-table">
      <thead><tr>
        <th>#</th><th>Category</th>
        <th class="num">Score</th><th class="num">Future EV</th><th class="num">Total</th>
      </tr></thead><tbody>`;
    r.category_options.forEach((opt, i) => {
      body += `<tr>
        <td>${i+1}</td>
        <td>${escHtml(opt.category)}</td>
        <td class="num">${opt.immediate_score}</td>
        <td class="num">${opt.future_ev.toFixed(2)}</td>
        <td class="num">${opt.total_value.toFixed(2)}</td>
      </tr>`;
    });
    body += '</tbody></table>';
  }

  if (r.top_reroll_options && r.top_reroll_options.length > 0) {
    body += `<table class="result-table">
      <thead><tr>
        <th>#</th><th>Keep</th>
        <th class="num">Reroll</th><th class="num">EV</th>
      </tr></thead><tbody>`;
    r.top_reroll_options.forEach((opt, i) => {
      body += `<tr>
        <td>${i+1}</td>
        <td>${escHtml(opt.keep || 'nothing')}</td>
        <td class="num">${opt.num_rerolled}</td>
        <td class="num">${opt.ev.toFixed(2)}</td>
      </tr>`;
    });
    body += '</tbody></table>';
  }

  document.getElementById('resultBody').innerHTML = body;

  // Scroll results into view
  results.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function escHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

// ── WASM Bootstrap ──
async function init() {
  const go = new Go();
  const loadingText = document.getElementById('loadingText');

  try {
    loadingText.textContent = 'Loading WebAssembly…';
    const result = await WebAssembly.instantiateStreaming(
      fetch('solver.wasm'),
      go.importObject
    );
    go.run(result.instance);

    loadingText.textContent = 'Loading EV table…';
    const resp = await fetch('ev_table.json');
    if (resp.ok) {
      const jsonStr = await resp.text();
      const err = jbfLoadEVTable(jsonStr);
      if (err) {
        loadingText.textContent = 'Computing EV table (first time)…';
        jbfComputeEVTable();
      }
    } else {
      loadingText.textContent = 'Computing EV table (first time, ~2s)…';
      jbfComputeEVTable();
    }

    wasmReady = true;
    document.getElementById('solveBtn').disabled = false;
    document.getElementById('loadingOverlay').style.display = 'none';
  } catch (e) {
    loadingText.textContent = 'Failed to load: ' + e.message;
    console.error(e);
  }
}

init();
</script>
</body>
</html>
